name: CI/CD OCI VM

on:
  push:
    branches:
      - main

env:
  OCI_REGION: ${{ secrets.OCI_REGION }}
  OCI_NAMESPACE: ${{ secrets.OCI_NAMESPACE }}
  OCIR_REGISTRY: "${{ secrets.OCI_REGION }}.ocir.io"
  APP_NAME: "hotel"

jobs:

  # ---------------------------------------------------------
  # BUILD & PUSH DOCKER IMAGES
  # ---------------------------------------------------------
  build-and-push-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.OCIR_REGISTRY }}
          username: ${{ secrets.OCI_USERNAME }}
          password: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build and push backend
        run: |
          docker build -t $OCIR_REGISTRY/$OCI_NAMESPACE/${APP_NAME}-backend:latest ./apps/backend
          docker push $OCIR_REGISTRY/$OCI_NAMESPACE/${APP_NAME}-backend:latest

      - name: Build and push frontend
        run: |
          docker build -t $OCIR_REGISTRY/$OCI_NAMESPACE/${APP_NAME}-frontend:latest ./apps/frontend
          docker push $OCIR_REGISTRY/$OCI_NAMESPACE/${APP_NAME}-frontend:latest

  # ---------------------------------------------------------
  # TERRAFORM
  # ---------------------------------------------------------
  terraform-apply:
    runs-on: ubuntu-latest
    needs: build-and-push-images

    defaults:
      run:
        working-directory: infra/terraform

    outputs:
      vm_ip: ${{ steps.export_ip.outputs.vm_ip }}

    env:
      TF_VAR_tenancy_id:       ${{ secrets.OCI_TENANCY_OCID }}
      TF_VAR_compartment_id:   ${{ secrets.OCI_COMPARTMENT_OCID }}
      TF_VAR_region:           ${{ secrets.OCI_REGION }}
      TF_VAR_label_prefix:     "hotel"

      TF_VAR_user_id:          ${{ secrets.OCI_USER_OCID }}
      TF_VAR_api_fingerprint:  ${{ secrets.OCI_API_FINGERPRINT }}
      TF_VAR_api_private_key:  ${{ secrets.OCI_API_PRIVATE_KEY }}

      TF_VAR_ssh_public_key_path:  "~/.ssh/vm-key.pub"
      TF_VAR_ssh_private_key_path: "~/.ssh/vm-key"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Escribir claves SSH
        run: |
          mkdir -p ~/.ssh
          echo "${TF_SSH_PRIVATE_KEY}" > ~/.ssh/vm-key
          echo "${TF_SSH_PUBLIC_KEY}"  > ~/.ssh/vm-key.pub
          chmod 600 ~/.ssh/vm-key
          chmod 644 ~/.ssh/vm-key.pub
        env:
          TF_SSH_PRIVATE_KEY: ${{ secrets.TF_SSH_PRIVATE_KEY }}
          TF_SSH_PUBLIC_KEY:  ${{ secrets.TF_SSH_PUBLIC_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -input=false

      - name: Terraform Apply
        run: terraform apply -auto-approve

      - name: Export VM IP
        id: export_ip
        run: |
          VM_IP=$(terraform output -raw public_ip)
          echo "vm_ip=$VM_IP"
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------
  # DEPLOY EN VM
  # ---------------------------------------------------------
  deploy-vm:
    runs-on: ubuntu-latest
    needs: terraform-apply

    env:
      VM_IP: ${{ needs.terraform-apply.outputs.vm_ip }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug IP
        run: |
            echo "VM_IP obtenido: $VM_IP"

      - name: Crear llaves SSH
        run: |
          mkdir -p ~/.ssh
          echo "${TF_SSH_PRIVATE_KEY}" > ~/.ssh/vm-key
          echo "${TF_SSH_PUBLIC_KEY}"  > ~/.ssh/vm-key.pub
          chmod 600 ~/.ssh/vm-key
          chmod 644 ~/.ssh/vm-key.pub
        env:
          TF_SSH_PRIVATE_KEY: ${{ secrets.TF_SSH_PRIVATE_KEY }}
          TF_SSH_PUBLIC_KEY:  ${{ secrets.TF_SSH_PUBLIC_KEY }}

      - name: Copiar docker-compose a la VM
        run: |
          scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/vm-key \
            deploy/docker-compose.yml \
            opc@$VM_IP:/home/opc/app/docker-compose.yml

      - name: Ejecutar deploy en la VM
        run: |
          ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/vm-key \
            opc@$VM_IP "
              cd /home/opc/app &&
              docker login $OCIR_REGISTRY -u $OCI_USERNAME -p $OCI_AUTH_TOKEN &&
              docker compose pull &&
              docker compose up -d
            "
        env:
          OCIR_REGISTRY: ${{ env.OCI_REGION }}.ocir.io
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
